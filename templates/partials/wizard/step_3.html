{# Wizard Step 3: Preview Parsed Data #}
{# Modal Overlay #}
<div class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
<div class="bg-[#3e3a46] rounded-[6px] border border-[rgba(255,255,255,0.10)] shadow-lg w-full {% if session_type == 'simulated' and preview_rows %}max-w-4xl{% else %}max-w-2xl{% endif %} max-h-[90vh] overflow-y-auto">
    {# Modal Header #}
    <div class="flex items-center justify-between p-4 border-b border-[rgba(255,255,255,0.10)]">
        <div class="flex items-center gap-2">
            <h2 class="text-lg font-semibold text-slate-100">Add Session</h2>
            {% if session_type == 'real_call' %}
            <span class="px-2 py-0.5 text-xs font-medium bg-red-900/20 text-[#dc2626] rounded">Real Call</span>
            {% else %}
            <span class="px-2 py-0.5 text-xs font-medium bg-blue-900/20 text-blue-400 rounded">Simulated</span>
            {% endif %}
        </div>
        <button onclick="document.getElementById('modal-container').innerHTML = ''" class="text-slate-400 hover:text-slate-300">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    {# Progress Steps #}
    <div class="px-4 py-3 border-b border-[rgba(255,255,255,0.10)] bg-[#36323e]">
        <div class="flex items-center justify-between text-xs">
            <div class="flex items-center gap-2">
                <span class="w-6 h-6 bg-[#16a34a] text-white rounded-full flex items-center justify-center font-medium">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                </span>
                <span class="text-slate-400">Type</span>
            </div>
            <div class="flex-1 h-0.5 bg-[#16a34a] mx-2"></div>
            <div class="flex items-center gap-2">
                <span class="w-6 h-6 bg-[#16a34a] text-white rounded-full flex items-center justify-center font-medium">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                </span>
                <span class="text-slate-400">Data</span>
            </div>
            <div class="flex-1 h-0.5 bg-[#16a34a] mx-2"></div>
            <div class="flex items-center gap-2">
                <span class="w-6 h-6 bg-[#dc2626] text-white rounded-full flex items-center justify-center font-medium">3</span>
                <span class="text-slate-100 font-medium">Preview</span>
            </div>
            <div class="flex-1 h-0.5 bg-[#46424e] mx-2"></div>
            <div class="flex items-center gap-2">
                <span class="w-6 h-6 bg-[#46424e] text-slate-400 rounded-full flex items-center justify-center font-medium">4</span>
                <span class="text-slate-400">Save</span>
            </div>
        </div>
    </div>

    {# Preview Content #}
    <form hx-post="/partials/session/wizard/validate/3" hx-target="#modal-container" hx-swap="innerHTML">
        {# Pass through all session data #}
        <input type="hidden" name="session_type" value="{{ session_type }}">
        <input type="hidden" name="event_date" value="{{ event_date }}">
        <input type="hidden" name="event_time" value="{{ event_time or '' }}">
        <input type="hidden" name="primary_provider_id" value="{{ primary_provider_id or '' }}">
        <input type="hidden" name="participant_ids" value="{{ participant_ids or '' }}">
        <input type="hidden" name="artifact_filename" value="{{ artifact_filename or '' }}">
        <input type="hidden" name="outcome" value="{{ outcome or '' }}">
        <input type="hidden" name="shocks_delivered" value="{{ shocks_delivered or '' }}">
        <input type="hidden" name="platoon" value="{{ platoon or '' }}">
        {# Zoll data availability fields #}
        <input type="hidden" name="zoll_data_available" value="{{ 'true' if zoll_data_available else 'false' }}">
        <input type="hidden" name="resuscitation_attempted" value="{{ resuscitation_attempted or '' }}">
        <input type="hidden" name="zoll_missing_reason" value="{{ zoll_missing_reason or '' }}">

        <div class="p-6 space-y-6">
            {# Parse Status #}
            {% if parse_error %}
            <div class="bg-red-900/20 border border-red-500/30 rounded-[6px] p-4">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-[#dc2626] mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <p class="text-sm font-medium text-[#dc2626]">Parse Error</p>
                        <p class="text-sm text-red-700 mt-1">{{ parse_error }}</p>
                    </div>
                </div>
            </div>
            {% elif unmatched_count > 0 %}
            <div class="bg-amber-900/20 border border-amber-500/30 rounded-[6px] p-4">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-amber-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <div>
                        <p class="text-sm font-medium text-amber-400">Provider Assignment Needed</p>
                        <p class="text-sm text-amber-600 mt-1">{{ parse_message or 'Some provider names could not be matched. Please assign them below.' }}</p>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="bg-green-900/20 border border-green-500/30 rounded-[6px] p-4">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-[#16a34a] mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <p class="text-sm font-medium text-[#16a34a]">Data Ready</p>
                        <p class="text-sm text-green-400 mt-1">{{ parse_message or 'Session data has been processed successfully.' }}</p>
                    </div>
                </div>
            </div>
            {% endif %}

            {# Simulated Sessions Preview Table #}
            {% if session_type == 'simulated' and preview_rows %}
            <div>
                <h3 class="text-sm font-medium text-slate-200 mb-3">Sessions to Import ({{ preview_rows|length }})</h3>
                <div class="border border-[rgba(255,255,255,0.10)] rounded-[6px] overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-[#36323e] text-slate-300 text-left">
                            <tr>
                                <th class="px-3 py-2 font-medium">Date</th>
                                <th class="px-3 py-2 font-medium">Provider</th>
                                <th class="px-3 py-2 font-medium text-center">Rate</th>
                                <th class="px-3 py-2 font-medium text-center">Depth %</th>
                                <th class="px-3 py-2 font-medium text-center">Rate %</th>
                                <th class="px-3 py-2 font-medium text-center">Duration</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-[rgba(255,255,255,0.10)]">
                            {% for row in preview_rows %}
                            <tr class="{% if not row.is_matched and row.provider_name_original %}bg-amber-900/20{% else %}hover:bg-[#36323e]{% endif %}">
                                <td class="px-3 py-2 text-slate-200">{{ row.date }}</td>
                                <td class="px-3 py-2">
                                    {% if row.is_matched %}
                                    {# Matched provider - show name with checkmark #}
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4 text-[#16a34a]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        <span class="text-slate-200">{{ row.matched_provider_name }}</span>
                                        <input type="hidden" name="provider_{{ row.row_index }}" value="{{ row.matched_provider_id }}">
                                    </div>
                                    {% elif row.provider_name_original %}
                                    {# Unmatched provider - show dropdown to assign #}
                                    <div class="space-y-1">
                                        <div class="flex items-center gap-2 text-amber-400">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                            </svg>
                                            <span class="text-xs">"{{ row.provider_name_original }}" not found</span>
                                        </div>
                                        <select name="provider_{{ row.row_index }}"
                                                class="w-full text-xs border border-amber-500/30 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500 bg-[#3e3a46]">
                                            <option value="">-- Assign Provider --</option>
                                            {% for provider in providers %}
                                            {% if provider.status == 'active' %}
                                            <option value="{{ provider.id }}">{{ provider.name }}</option>
                                            {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                    {% else %}
                                    {# No provider name in CSV #}
                                    <select name="provider_{{ row.row_index }}"
                                            class="w-full text-xs border border-[rgba(255,255,255,0.15)] rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-[#dc2626] focus:border-[#dc2626] bg-[#3e3a46]">
                                        <option value="">-- Select Provider --</option>
                                        {% for provider in providers %}
                                        {% if provider.status == 'active' %}
                                        <option value="{{ provider.id }}">{{ provider.name }}</option>
                                        {% endif %}
                                        {% endfor %}
                                    </select>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2 text-center text-slate-200">{{ row.compression_rate or '—' }}</td>
                                <td class="px-3 py-2 text-center text-slate-200">{% if row.correct_depth_percent is not none %}{{ row.correct_depth_percent }}%{% else %}—{% endif %}</td>
                                <td class="px-3 py-2 text-center text-slate-200">{% if row.correct_rate_percent is not none %}{{ row.correct_rate_percent }}%{% else %}—{% endif %}</td>
                                <td class="px-3 py-2 text-center text-slate-200">{% if row.duration %}{{ row.duration }}s{% else %}—{% endif %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
            {# Session Summary for Real Call or single session #}
            <div>
                <h3 class="text-sm font-medium text-slate-200 mb-3">Session Summary</h3>
                <div class="bg-[#36323e] rounded-[6px] p-4 space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Type</span>
                        <span class="text-slate-100 font-medium">{{ 'Real Call' if session_type == 'real_call' else 'Simulated' }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Date</span>
                        <span class="text-slate-100">{{ event_date }}</span>
                    </div>
                    {% if event_time %}
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Time</span>
                        <span class="text-slate-100">{{ event_time }}</span>
                    </div>
                    {% endif %}
                    {% if primary_provider_name %}
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Primary Practitioner</span>
                        <span class="text-slate-100">{{ primary_provider_name }}</span>
                    </div>
                    {% endif %}
                    {% if participant_count and participant_count > 0 %}
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Additional Participants</span>
                        <span class="text-slate-100">{{ participant_count }}</span>
                    </div>
                    {% endif %}
                    {% if session_type == 'real_call' and outcome %}
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Patient Outcome</span>
                        <span class="{% if outcome == 'ROSC' %}text-[#16a34a] font-medium{% elif outcome == 'No ROSC' %}text-[#dc2626]{% else %}text-slate-100{% endif %}">{{ outcome }}</span>
                    </div>
                    {% endif %}
                    {% if session_type == 'real_call' and shocks_delivered %}
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Shocks Delivered</span>
                        <span class="text-slate-100">{{ shocks_delivered }}</span>
                    </div>
                    {% endif %}
                    {% if platoon %}
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Platoon</span>
                        <span class="text-slate-100">Platoon {{ platoon }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {# Metrics Preview (if available) #}
            {% if preview_metrics %}
            <div>
                <h3 class="text-sm font-medium text-slate-200 mb-3">Key Metrics</h3>
                <div class="grid grid-cols-2 gap-3">
                    {% if preview_metrics.duration %}
                    <div class="bg-[#36323e] rounded-[6px] p-3">
                        <p class="text-xs text-slate-400">Duration</p>
                        <p class="text-lg font-semibold text-slate-100">{{ preview_metrics.duration }}s</p>
                    </div>
                    {% endif %}
                    {% if preview_metrics.compression_rate %}
                    <div class="bg-[#36323e] rounded-[6px] p-3">
                        <p class="text-xs text-slate-400">Compression Rate</p>
                        <p class="text-lg font-semibold text-slate-100">{{ preview_metrics.compression_rate }} CPM</p>
                    </div>
                    {% endif %}
                    {% if preview_metrics.correct_depth_percent is not none %}
                    <div class="bg-[#36323e] rounded-[6px] p-3">
                        <p class="text-xs text-slate-400">Depth Compliance</p>
                        <p class="text-lg font-semibold text-slate-100">{{ preview_metrics.correct_depth_percent }}%</p>
                    </div>
                    {% endif %}
                    {% if preview_metrics.correct_rate_percent is not none %}
                    <div class="bg-[#36323e] rounded-[6px] p-3">
                        <p class="text-xs text-slate-400">Rate Compliance</p>
                        <p class="text-lg font-semibold text-slate-100">{{ preview_metrics.correct_rate_percent }}%</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {# CanROC Fields (Real Call only) #}
            {% if session_type == 'real_call' and canroc_fields_count %}
            <div>
                <h3 class="text-sm font-medium text-slate-200 mb-3">CanROC Auto-fill</h3>
                <div class="bg-blue-900/20 border border-blue-500/30 rounded-[6px] p-4">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span class="text-sm text-blue-400">{{ canroc_fields_count }} PCO fields ready for export</span>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        {# Footer #}
        <div class="flex items-center justify-between p-4 border-t border-[rgba(255,255,255,0.10)] bg-[#36323e]">
            <button type="button"
                    hx-post="/partials/session/wizard/back/2"
                    hx-target="#modal-container"
                    hx-swap="innerHTML"
                    hx-vals='{{ {"session_type": session_type, "event_date": event_date, "event_time": event_time or ""} | tojson }}'
                    class="px-4 py-2 text-sm text-slate-300 hover:text-slate-100">
                Back
            </button>
            <button type="submit" class="px-4 py-2 bg-[#dc2626] text-white text-sm font-medium rounded-[6px] hover:bg-[#b91c1c] transition-colors" {% if parse_error %}disabled{% endif %}>
                {% if preview_rows and preview_rows|length > 1 %}Save {{ preview_rows|length }} Sessions{% else %}Save Session{% endif %}
            </button>
        </div>
    </form>
</div>
</div>
