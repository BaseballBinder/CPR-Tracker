<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }} | CPR Tracking System</title>

    <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg">

    <!-- Tailwind CSS (vendored for offline use) -->
    <script src="/static/vendor/js/tailwindcss.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Fire department palette (per UX_SPEC.md)
                        fire: {
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                        },
                        ember: {
                            300: '#fdba74',
                            500: '#f97316',
                        },
                        steel: {
                            500: '#64748b',
                        },
                        // Status colors
                        success: {
                            600: '#16a34a',
                        },
                        warning: {
                            600: '#d97706',
                        },
                        error: {
                            700: '#b91c1c',
                        },
                        info: {
                            600: '#2563eb',
                        },
                        // Ember Dark theme surfaces
                        dark: {
                            body: '#2c2834',
                            sidebar: '#221e28',
                            topbar: '#36323e',
                            card: '#3e3a46',
                            'card-alt': '#46424e',
                            input: '#46424e',
                        },
                    },
                    fontFamily: {
                        sans: ['"Source Sans 3"', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <!-- Source Sans 3 Font (self-hosted for offline use) -->
    <link rel="stylesheet" href="/static/vendor/fonts/source-sans-3.css">

    <!-- HTMX (for partial updates) -->
    <script src="/static/vendor/js/htmx.min.js"></script>

    <!-- Alpine.js (for sidebar toggle and dropdowns) -->
    <script defer src="/static/vendor/js/alpine.min.js"></script>

    <!-- Chart.js for trend charts -->
    <script src="/static/vendor/js/chart.min.js"></script>

    <!-- Custom styles -->
    <link rel="stylesheet" href="/static/css/app.css">

    <!-- HTMX loading indicator styles -->
    <style>
        /* Loading indicator for HTMX requests */
        .htmx-request .htmx-indicator {
            display: block !important;
        }
        .htmx-indicator {
            display: none;
        }
        /* Fade out old content during swap */
        .htmx-swapping {
            opacity: 0.5;
            transition: opacity 200ms ease-out;
        }
        /* Skeleton pulse animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-[#2c2834] font-sans text-slate-200 antialiased" x-data="{ sidebarOpen: false }">
    <div class="min-h-screen flex">
        <!-- Mobile sidebar overlay -->
        <div
            x-show="sidebarOpen"
            x-transition:enter="transition-opacity ease-linear duration-200"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition-opacity ease-linear duration-200"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            class="fixed inset-0 bg-slate-900/50 z-40 lg:hidden"
            @click="sidebarOpen = false"
        ></div>

        <!-- Sidebar -->
        {% include "components/sidebar.html" %}

        <!-- Main content area -->
        <div class="flex-1 flex flex-col min-w-0">
            <!-- Topbar -->
            {% include "components/topbar.html" %}

            <!-- Page content -->
            <main class="flex-1 p-4 lg:p-6 overflow-auto">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <!-- Modal container (for future wizard modal) -->
    <div id="modal-container"></div>

    <!-- Toast container (for future notifications) -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <!-- Alpine Component Definitions (must be before Alpine initializes) -->
    <script>
        // Global Alpine component registration for HTMX-loaded partials
        document.addEventListener('alpine:init', () => {
            // Wizard Step 2 Real Call component
            Alpine.data('wizardStep2Real', () => ({
                fileName: '',
                dragOver: false,
                providerSearch: '',
                participantSearch: '',
                selectedPrimary: '',
                selectedParticipants: [],
                providers: [],
                zollDataAvailable: true,
                resuscitationAttempted: '',
                zollMissingReason: '',
                primaryDropdownOpen: false,
                showAddForm: false,
                newFirstName: '',
                newLastName: '',
                newCertification: '',
                participantDropdownOpen: false,
                showParticipantAddForm: false,
                participantFirstName: '',
                participantLastName: '',
                participantCertification: '',

                init() {
                    // Parse JSON data from script tags when component initializes
                    const providersRaw = document.getElementById('step2-providers-json')?.textContent || '[]';
                    const participantsRaw = document.getElementById('step2-selected-participants-json')?.textContent || '[]';

                    try {
                        const allProviders = JSON.parse(providersRaw);
                        this.providers = (allProviders || []).filter(p => p && p.status === 'active');
                    } catch (e) {
                        console.error("Failed to parse providers JSON", e, providersRaw.slice(0, 500));
                    }

                    try {
                        this.selectedParticipants = JSON.parse(participantsRaw);
                    } catch (e) {
                        console.error("Failed to parse selected participants JSON", e);
                    }
                },

                get filteredProviders() {
                    if (!this.providerSearch) return this.providers;
                    const search = this.providerSearch.toLowerCase();
                    return this.providers.filter(p => p && p.name && p.name.toLowerCase().includes(search));
                },

                get filteredParticipants() {
                    if (!this.participantSearch) return this.providers;
                    const search = this.participantSearch.toLowerCase();
                    return this.providers.filter(p => p && p.name && p.name.toLowerCase().includes(search));
                },

                toggleParticipant(id) {
                    const idx = this.selectedParticipants.indexOf(id);
                    if (idx === -1) {
                        this.selectedParticipants.push(id);
                    } else {
                        this.selectedParticipants.splice(idx, 1);
                    }
                },

                getProviderName(id) {
                    const p = this.providers.find(p => p && p.id === id);
                    return p ? p.name : '';
                },

                setNoZollData() {
                    this.zollDataAvailable = false;
                    this.fileName = '';
                    if (this.$refs.fileInput) this.$refs.fileInput.value = '';
                },

                setZollDataAvailable() {
                    this.zollDataAvailable = true;
                    this.resuscitationAttempted = '';
                    this.zollMissingReason = '';
                }
            }));

            // Edit Session Modal component
            Alpine.data('editSessionModal', () => ({
                saving: false,
                providers: [],
                providerSearch: '',
                participantSearch: '',
                selectedPrimary: '',
                selectedParticipants: [],
                primaryDropdownOpen: false,
                showAddForm: false,
                newFirstName: '',
                newLastName: '',
                newCertification: '',
                showAddParticipantForm: false,
                newParticipantFirstName: '',
                newParticipantLastName: '',
                newParticipantCertification: '',

                init() {
                    // Parse JSON data from script tags when component initializes
                    const providersRaw = document.getElementById('edit-modal-providers-json')?.textContent || '[]';
                    const participantsRaw = document.getElementById('edit-modal-participants-json')?.textContent || '[]';

                    try {
                        const allProviders = JSON.parse(providersRaw);
                        this.providers = (allProviders || []).filter(p => p && p.status === 'active');
                    } catch (e) {
                        console.error("Failed to parse providers JSON", e, providersRaw.slice(0, 500));
                    }

                    try {
                        this.selectedParticipants = JSON.parse(participantsRaw);
                    } catch (e) {
                        console.error("Failed to parse selected participants JSON", e);
                    }
                },

                get filteredProviders() {
                    if (!this.providerSearch) return this.providers;
                    const search = this.providerSearch.toLowerCase();
                    return this.providers.filter(p => p && p.name && p.name.toLowerCase().includes(search));
                },

                get filteredParticipants() {
                    if (!this.participantSearch) return this.providers;
                    const search = this.participantSearch.toLowerCase();
                    return this.providers.filter(p => p && p.name && p.name.toLowerCase().includes(search));
                },

                toggleParticipant(id) {
                    const idx = this.selectedParticipants.indexOf(id);
                    if (idx === -1) {
                        this.selectedParticipants.push(id);
                    } else {
                        this.selectedParticipants.splice(idx, 1);
                    }
                },

                getProviderName(id) {
                    const p = this.providers.find(p => p && p.id === id);
                    return p ? p.name : '';
                }
            }));

            // Sync status indicator component
            Alpine.data('syncIndicator', () => ({
                enabled: false,
                pushing: false,
                pulling: false,
                lastPush: null,
                lastError: null,
                agoText: '',
                _interval: null,

                init() {
                    this.poll();
                    this._interval = setInterval(() => this.poll(), 10000);
                },

                destroy() {
                    if (this._interval) clearInterval(this._interval);
                },

                async poll() {
                    try {
                        const resp = await fetch('/api/sync/status');
                        if (!resp.ok) return;
                        const d = await resp.json();
                        this.enabled = d.enabled;
                        this.pushing = d.push_in_progress;
                        this.pulling = d.pull_in_progress;
                        this.lastPush = d.last_push_time;
                        this.lastError = d.last_error;
                        this.agoText = this.lastPush ? this.timeAgo(this.lastPush) : '';
                    } catch (_) {}
                },

                timeAgo(iso) {
                    const diff = Math.floor((Date.now() - new Date(iso).getTime()) / 1000);
                    if (diff < 60) return 'Synced just now';
                    if (diff < 3600) return 'Synced ' + Math.floor(diff / 60) + 'm ago';
                    if (diff < 86400) return 'Synced ' + Math.floor(diff / 3600) + 'h ago';
                    return 'Synced ' + Math.floor(diff / 86400) + 'd ago';
                },
            }));
        });

        // Reinitialize Alpine for HTMX-swapped content
        document.body.addEventListener('htmx:afterSwap', (e) => {
            if (e.target.id === 'modal-container' || e.target.closest('#modal-container')) {
                Alpine.initTree(e.target);
            }
        });
    </script>

    <!-- Custom JS -->
    <script src="/static/js/app.js"></script>
</body>
</html>
