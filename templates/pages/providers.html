{% extends "base.html" %}

{% block content %}
{# Page Header #}
{% set page_title = "Providers" %}
{% set page_subtitle = "Manage provider roster and view performance" %}
{% set page_actions = [{"text": "Add Provider", "variant": "primary", "icon": "plus", "hx_get": "/partials/providers/add-modal", "hx_target": "#modal-container"}] %}
{% include "components/page_header.html" %}

{# Quick Stats Row #}
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 page-enter page-d1">
    {% set stat_label = "Total Providers" %}
    {% set stat_value = providers | length %}
    {% set stat_icon = "users" %}
    {% set stat_icon_bg = "bg-[#46424e]" %}
    {% set stat_icon_color = "text-slate-300" %}
    {% set stat_trend = "" %}
    {% set stat_trend_direction = "neutral" %}
    {% set stat_trend_label = "" %}
    {% include "components/stat_card.html" %}

    {% set stat_label = "Active" %}
    {% set stat_value = providers | selectattr('status', 'equalto', 'active') | list | length %}
    {% set stat_icon = "check" %}
    {% set stat_icon_bg = "bg-green-900/20" %}
    {% set stat_icon_color = "text-[#16a34a]" %}
    {% include "components/stat_card.html" %}

    {% set stat_label = "Inactive" %}
    {% set stat_value = providers | selectattr('status', 'equalto', 'inactive') | list | length %}
    {% set stat_icon = "clock" %}
    {% set stat_icon_bg = "bg-[#46424e]" %}
    {% set stat_icon_color = "text-slate-400" %}
    {% include "components/stat_card.html" %}
</div>

{# Filters Bar #}
<div class="bg-gradient-to-br from-[#3e3a46] via-[#3e3a46] to-[#46424e]/40 rounded-2xl border border-[rgba(255,255,255,0.07)] p-4 mb-6 shadow-sm page-enter page-d2">
    <div class="flex flex-wrap items-center gap-3">
        <select
            class="text-sm border border-[rgba(255,255,255,0.15)] rounded-[6px] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#dc2626] focus:border-[#dc2626] bg-[#3e3a46]"
            name="status"
            hx-get="/partials/providers/table"
            hx-target="#providers-table"
            hx-swap="innerHTML"
            hx-include="[name='team'], [name='certification']"
            hx-indicator="#providers-loading"
        >
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
        </select>

        <select
            class="text-sm border border-[rgba(255,255,255,0.15)] rounded-[6px] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#dc2626] focus:border-[#dc2626] bg-[#3e3a46]"
            name="team"
            hx-get="/partials/providers/table"
            hx-target="#providers-table"
            hx-swap="innerHTML"
            hx-include="[name='status'], [name='certification']"
            hx-indicator="#providers-loading"
        >
            <option value="">All Teams</option>
            {% for team in teams %}
            <option value="{{ team.id }}">{{ team.name }}</option>
            {% endfor %}
        </select>

        <select
            class="text-sm border border-[rgba(255,255,255,0.15)] rounded-[6px] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#dc2626] focus:border-[#dc2626] bg-[#3e3a46]"
            name="certification"
            hx-get="/partials/providers/table"
            hx-target="#providers-table"
            hx-swap="innerHTML"
            hx-include="[name='status'], [name='team']"
            hx-indicator="#providers-loading"
        >
            <option value="">All Certifications</option>
            <option value="ACP">ACP</option>
            <option value="PCP">PCP</option>
            <option value="Mechanic">Mechanic</option>
        </select>

        {# Loading indicator #}
        <div id="providers-loading" class="htmx-indicator">
            <div class="inline-flex items-center gap-2 text-slate-400">
                <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-sm">Loading...</span>
            </div>
        </div>

        <div class="flex-1"></div>

        <a href="/providers" class="text-sm text-slate-400 hover:text-slate-200">Reset filters</a>
    </div>
</div>

{# Providers Table #}
<div class="bg-gradient-to-br from-[#3e3a46] via-[#3e3a46] to-[#46424e]/40 rounded-2xl border border-[rgba(255,255,255,0.07)] shadow-sm page-enter page-d3">
    <div class="overflow-x-auto" id="providers-table">
        <table class="w-full text-sm">
            <thead class="bg-[#2c2834] text-slate-300 text-left sticky top-0">
                <tr>
                    <th class="px-4 py-3 font-medium">Name</th>
                    <th class="px-4 py-3 font-medium">Certification</th>
                    <th class="px-4 py-3 font-medium">Sessions</th>
                    <th class="px-4 py-3 font-medium">Last Session</th>
                    <th class="px-4 py-3 font-medium">JcLS</th>
                    <th class="px-4 py-3 font-medium">Trend</th>
                    <th class="px-4 py-3 font-medium">Status</th>
                    <th class="px-4 py-3 font-medium">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-[rgba(255,255,255,0.04)]">
                {% for provider in providers %}
                <tr class="hover:bg-[#36323e]">
                    <td class="px-4 py-3">
                        <a href="/providers/{{ provider.id }}" class="text-slate-100 font-medium hover:text-[#dc2626]">
                            {{ provider.name }}
                        </a>
                    </td>
                    <td class="px-4 py-3">
                        {% if provider.certification == 'ACP' %}
                        {% set badge_text = "ACP" %}
                        {% set badge_variant = "error" %}
                        {% elif provider.certification == 'PCP' %}
                        {% set badge_text = "PCP" %}
                        {% set badge_variant = "warning" %}
                        {% else %}
                        {% set badge_text = provider.certification %}
                        {% set badge_variant = "neutral" %}
                        {% endif %}
                        {% include "components/badge.html" %}
                    </td>
                    <td class="px-4 py-3 text-slate-200">
                        {% if provider.stats and provider.stats.session_count > 0 %}
                        {{ provider.stats.session_count }}
                        {% else %}
                        <span class="text-slate-400">0</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-slate-400 text-xs">
                        {% if provider.last_session_date %}
                        {{ provider.last_session_date }}
                        {% else %}
                        <span class="text-slate-400">—</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-slate-200">
                        {% if provider.stats and provider.stats.avg_jcls_score %}
                        <span class="font-medium {% if provider.stats.avg_jcls_score >= 80 %}text-[#16a34a]{% elif provider.stats.avg_jcls_score >= 60 %}text-amber-600{% else %}text-[#dc2626]{% endif %}">
                            {{ provider.stats.avg_jcls_score }}
                        </span>
                        {% else %}
                        <span class="text-slate-400">&mdash;</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3">
                        {% if provider.stats and provider.stats.session_count > 0 %}
                        <span class="text-slate-400 text-xs">
                            D:{{ provider.stats.avg_depth_compliance }}% R:{{ provider.stats.avg_rate_compliance }}%
                        </span>
                        {% else %}
                        <span class="text-slate-400 text-xs">—</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3">
                        {% if provider.status == 'active' %}
                        {% set badge_text = "Active" %}
                        {% set badge_variant = "success" %}
                        {% else %}
                        {% set badge_text = "Inactive" %}
                        {% set badge_variant = "neutral" %}
                        {% endif %}
                        {% include "components/badge.html" %}
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-2">
                            <a href="/providers/{{ provider.id }}" class="text-slate-400 hover:text-slate-300" title="View details">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </a>
                            <button
                                hx-get="/partials/providers/{{ provider.id }}/edit-modal"
                                hx-target="#modal-container"
                                class="text-slate-400 hover:text-slate-300"
                                title="Edit">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button
                                hx-get="/partials/providers/{{ provider.id }}/delete-modal"
                                hx-target="#modal-container"
                                class="text-slate-400 hover:text-[#dc2626]"
                                title="Delete">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="px-4 py-12">
                        {% set empty_icon = "users" %}
                        {% set empty_title = "No providers yet" %}
                        {% set empty_message = "Add your first provider to start tracking performance" %}
                        {% set empty_cta_text = "Add Provider" %}
                        {% set empty_cta_href = "#" %}
                        {% include "components/empty_state.html" %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{# Modal Container for Add Provider #}
<div id="modal-container"></div>
{% endblock %}
